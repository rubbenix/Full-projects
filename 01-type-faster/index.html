<style>
    :root{
        color-scheme: light dark;
        --green: #4ade80;
        --red: #f87171;
        --yellow: #fbbf24;
        --black: #222;
        --gray: #8f9195;
    }
    body{
        background: var(--black);
        font-family: Menlo, monospace;
        display: grid;
        padding: 32px;
        justify-content: center;
        margin-top: 32px;
        padding: 16px;
    }
    section{
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-width: 500px;
    }
    time{
        color: var(--green);
    }
    input{
        z-index: -999;
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        /*opacity: 0;*/
    }
    p{
        display: flex;
        flex-wrap: wrap;
        gap: 3px 8px;
        margin: 0px;
    }
    x-letter {
        color: var(--gray);
        position: relative;

        &.active::before {
            content: '|';
            color: var(--yellow);
            font-size: 14px;
            position: absolute;
            left: -65%;
            animation: 1.2s blink infinite ease-in-out;
        }
        &.active.is-last::before {
            left: 65%;
        }

        &.correct {
            color: var(--green);
        }

        &.incorrect {
            color: var(--red);
        }
    }
    x-word{
        border-bottom: 1.5px solid transparent;
        transition: border-color 0.3s ease-in-out;
        &.marked {
            border-color: var(--red);
        }
    }
    @keyframes blink {
        0%, 25% { opacity: 1; }
        75% { opacity: 0; }
    }
</style>

<body>
    <main>
        <section id = "game">
            <time id="timer"></time>
            <p id="p"></p>
            <input autofocus id="input">
        </section>
    </main>
</body>

<script>
    const timerElement = document.getElementById("timer");
    const paragraphElement = document.getElementById("p");
    const inputElement = document.getElementById("input");

    const INITIAL_TIME = 60
    const TEXT = "the world blue is our over beautiful things."

    let currentTime = INITIAL_TIME
    let words = []

    initGame()
    initEvents()

    function initGame() {
        words = TEXT.split(' ').slice(0, 32)
        currentTime = INITIAL_TIME;

        timerElement.textContent = currentTime;

        paragraphElement.innerHTML = words.map((word, index) => {
            const letters = word.split('')
            //también podriamos substituir <x-word> por <span>  
            //Custom elements, creas tus propias etiquetas
            return `<x-word>
                ${letters
                    .map(letter => `<x-letter>${letter}</x-letter>`)
                    .join('')}
            </x-word>
            `
        }).join('')
    }

    //Seleccionamos la primera palabra del párrafo
    const firstWordElement = paragraphElement.querySelector('x-word')
    firstWordElement.classList.add('active')
    firstWordElement.querySelector('x-letter').classList.add('active')

    const intervalId = setInterval(() => {
        currentTime--;
        timerElement.textContent = currentTime

        if (currentTime === 0) {
            clearInterval(intervalId)
            gameOver()
        }
    }, 1000);


    function initEvents() {
        // Focus on the input when a key is pressed (testear live)
        document.addEventListener('keydown', () => {
            inputElement.focus();
        });

        inputElement.addEventListener('keydown', onKeyDown)
        inputElement.addEventListener('keyup', onKeyUp)
    }
    function onKeyDown(event){
        const currentWordElement = paragraphElement.querySelector('x-word.active')
        const currentLetterElement = currentWordElement.querySelector('x-letter.active')

        const {key} = event
        if(key === ' '){
            event.preventDefault();
            //recuperar la siguiente palabra 'hermana'
            const nextWordElement = currentWordElement.nextElementSibling
            const nextLetterElement = nextWordElement.querySelector('x-letter')

            currentWordElement.classList.remove('active','marked','correct')
            currentLetterElement.classList.remove('active')

            nextWordElement.classList.add('active')
            nextLetterElement.classList.add('active')
            //resetear input una vez cambiado de palabra
            inputElement.value = ''
            // comprobar si todas las letras son correctas
            const allLetters = currentWordElement.querySelectorAll('x-letter');
            const allCorrect = Array.from(allLetters).every(l => l.classList.contains('correct'));
            if (allCorrect) {
                currentWordElement.classList.add('correct');
            } else {
                currentWordElement.classList.add('marked');
            }
            return;
        }
        //dar al boton de retroceso para volver a la palabra anterior.
        if(key === 'Backspace'){
            const previousWordElement = currentWordElement.previousElementSibling
            const previousLetterElement = currentLetterElement.previousElementSibling

            // Solo si estamos en la primera letra y la palabra anterior está marcada
            if(previousWordElement && !previousLetterElement && previousWordElement.classList.contains('marked')){
                event.preventDefault();
                previousWordElement.classList.remove('marked'); // Quita la línea roja
                previousWordElement.classList.remove('correct'); // Quita el verde si lo tuviera
                previousWordElement.classList.add('active');
                currentWordElement.classList.remove('active');
                currentLetterElement.classList.remove('active');

                // Buscar la última letra escrita (correcta o incorrecta)
                const allPrevLetters = previousWordElement.querySelectorAll('x-letter');
                let lastTypedIndex = -1;
                allPrevLetters.forEach((l, idx) => {
                    if(l.classList.contains('correct') || l.classList.contains('incorrect')) lastTypedIndex = idx;
                });

                allPrevLetters.forEach(l => l.classList.remove('active', 'is-last'));
                if(lastTypedIndex >= 0) {
                    allPrevLetters[lastTypedIndex].classList.add('active');
                    // Solo letras que el usuario ya escribió (correctas o incorrectas)
                    const typedLetters = previousWordElement.querySelectorAll('x-letter.correct, x-letter.incorrect');
                    inputElement.value = Array.from(typedLetters).map($el =>
                        $el.classList.contains('correct') ? $el.innerText : '*'
                    ).join('');
                } else {
                    allPrevLetters[0].classList.add('active');
                    inputElement.value = '';
                }
                return;
            }
        }
    }
    function onKeyUp(){
        //recuperar elementos actuales
        const currentWordElement = paragraphElement.querySelector('x-word.active')
        const currentLetterElement = currentWordElement.querySelector('x-letter.active')
        const currentWord = currentWordElement.innerText.trim()
        inputElement.maxLength = currentWord.length
        console.log({ value: inputElement.value, currentWord })

        const allLettersElement = currentWordElement.querySelectorAll('x-letter')

        allLettersElement.forEach(letter => letter.classList.remove('correct', 'incorrect'))
        inputElement.value.split('').forEach((char,index) => {
            const letterElement = allLettersElement[index]
            const letterToCheck = currentWord[index]

            const isCorrect = letterToCheck === char
            const letterClass = isCorrect ? 'correct' : 'incorrect'
           
            letterElement.classList.add(letterClass)
        });

        //mover el cusor cada vez que se escribe una letra
        currentLetterElement.classList.remove('active', 'is-last')
        const inputLength = inputElement.value.length
        const nextActiveLetterElement = allLettersElement[inputLength]
        if(nextActiveLetterElement){
            nextActiveLetterElement.classList.add('active')
        }else{
            currentLetterElement.classList.add('active', 'is-last')
        }
       
    }


    function gameOver(){
        console.log("Game Over");
    }
</script>
    
